<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE project>
<project name="SFWeb" default="build" basedir="..">

	<property name="application.name" value="languageforge" />

	<property name="build.number" value="0.0.0.0" />
	<property name="build.output" value="output" />
	<property name="build.libJsFile" value="${build.output}/${application.name}.js" />
	<property name="build.minJsFile" value="${build.output}/${application.name}.min.js" />
	<property name="build.packageFile" value="${build.output}/${application.name}.tgz" />
	<property name="build.packageFileForTest" value="${build.output}/${application.name}_e2etest.tgz" />
	<property name="build.installPath" value="/var/www/languageforge.org_dev" />
	<property name="build.installForTestPath" value="/var/www/languageforge.org_e2etest" />
	<property name="build.uploadPath" value="/var/www/languageforge.org" />

	<target name="clean" depends="cleanLibs">
		<delete dir="${build.output}" quiet="true" />
	</target>
		
	<target name="cleanLibs">
	</target>

	<target name="cleanInstall" depends="">
		<delete dir="${build.installPath}" quiet="true" />
	</target>
	
	<target name="cleanInstallForE2eTest" depends="">
		<delete dir="${build.installForTestPath}" quiet="true" />
		<mkdir dir="${build.installForTestPath}" />
	</target>

	<target name="cleanUpload" depends="">
		<delete dir="${build.uploadPath}" quiet="true" />
	</target>

	<target name="version">
	    <property name="version" value="${build.number}" />
		<echo>${version}</echo>
	</target>
	
	<target name="prepare">
		<mkdir dir="${build.output}" />
	</target>

	<target name="build" />

	<target name="test-js-unit" depends="composer">
		<exec dir="test/app" executable="node">
			<arg value="node_modules/karma/bin/karma" />
			<arg value="start" />
			<arg file="test/karma.conf.js" />
			<arg value="--reporters" />
			<arg value="teamcity" />
			<arg value="--single-run" />
		 </exec>
	</target>

	<target name="test-php" depends="prepare,composer">
		 <echo>##teamcity[importData type='junit' path='${build.output}/AllTests.xml']</echo>
		 <exec executable="php" dir="test/php" output="${build.output}/AllTests.xml"  error="${build.output}/error.log" failonerror="true">
			<arg line="AllTests.php" />
			<arg value="-j" />
		 </exec>
	 </target>

	<target name="test">
	    <!-- commented out until these are revisited and made working again (the e2e tests are hanging as of 2013-10-24 cjh)
		E2E tests still commented out since we are changing how they work (they will now be run from a Windows build agent instead of from the Ant build script): 2014-08-06 RM
		<antcall target="test-js-e2e" />
		-->
		<antcall target="test-php" />
		<antcall target="test-js-unit" />
	</target>
	
	<target name="composer">
		 <exec executable="composer" dir="src" failonerror="true">
			<arg line="install" />
		 </exec>	    
	</target>

	<target name="minify" depends="prepare">
		<concat destfile="${build.libJsFile}" overwrite="yes" fixlastline="yes">
			<fileset dir="src/angular-app"
				includes="**/*.js"
				excludes="**/*.min.js,**/assets/**, **/vendor/**"
			/>
			<fileset dir="src/js/lib"
				includes="ng-ui-*.js"
				excludes="ng-ui-*.min.js"
			/>
		</concat>
		<exec executable="/usr/bin/yui-compressor">
			<arg value="-o" />
			<arg value="${build.minJsFile}" />
			<arg value="${build.libJsFile}" />
		</exec>
	</target>

	<target name="copyWeb" depends="prepare,composer,minify,version">
		<copy todir="${build.output}/package/htdocs">
			<fileset dir="src"/>
		</copy>
		<copy todir="${build.output}/package/lib">
			<fileset dir="lib"/>
		</copy>
		<copy todir="${build.output}/package/htdocs/js/lib"
			file="${build.minJsFile}"
		/>
		<replace file="${build.output}/package/htdocs/config/sf_config.php">
			<replacefilter token="$config['sfenv'] = 'dev';" value="$config['sfenv'] = 'prod';" />
		</replace>
	    <replace file="${build.output}/package/htdocs/version.php">
			<replacefilter token="9.9.9" value="${version}" />
		</replace>
		<chgrp type="both" group="www-data">
			<dirset dir="${build.output}/package/htdocs/" />
			<fileset dir="${build.output}/package/htdocs/">
			    <include name="**/*"/>
			</fileset>
			<dirset dir="${build.output}/package/lib/" />
			<fileset dir="${build.output}/package/lib/">
			    <include name="**/*"/>
			</fileset>
		</chgrp>
		<chmod type="both" perm="g+w">
			<dirset dir="${build.output}/package/htdocs/cache/" />
			<dirset dir="${build.output}/package/htdocs/assets/" />
		</chmod>
	</target>
	
	<target name="copyForE2ETest" depends="copyWeb">
		<copy todir="${build.output}/package/test">
			<fileset dir="test"/>
		</copy>
		<chgrp type="both" group="www-data">
			<dirset dir="${build.output}/package/test/" />
			<fileset dir="${build.output}/package/test/">
			    <include name="**/*"/>
			</fileset>
		</chgrp>
	</target>
	
	<target name="package" depends="clean,prepare,copyWeb" >
		<tar 
			destfile="${build.packageFile}"
			basedir="${build.output}/package"
			excludes="${build.packageFile},${build.packageFileForTest}"
			longfile="gnu"
			compression="gzip" />
	</target>
	
	<target name="packageForE2ETest" depends="clean,prepare,copyForE2ETest" >
		<tar 
			destfile="${build.packageFileForTest}"
			basedir="${build.output}/package"
			excludes="${build.packageFile},${build.packageFileForTest}"
			longfile="gnu"
			compression="gzip" />
	</target>
	
	<target name="install" depends="package,cleanInstall">
		<untar src="${build.packageFile}" dest="${build.installPath}" compression="gzip" />
		<chgrp type="both" group="www-data">
			<dirset dir="${build.installPath}/htdocs/" />
			<fileset dir="${build.installPath}/htdocs/">
			    <include name="**/*"/>
			</fileset>
			<dirset dir="${build.installPath}/lib/" />
			<fileset dir="${build.installPath}/lib/">
			    <include name="**/*"/>
			</fileset>
		</chgrp>
		<chmod type="both" perm="g+w">
			<dirset dir="${build.installPath}/htdocs/cache/" />
			<dirset dir="${build.installPath}/htdocs/assets/" />
		</chmod>
		<!--
		<chown type="both" owner="www-data">
			<dirset dir="${build.installPath}/htdocs/cache/" />
		</chown>
		<chmod type="both" perm="g+w">
			<dirset dir="${build.installPath}/web/sites/default/files/" />
			<fileset dir="${build.installPath}/web/sites/default/files/">
			    <include name="**/*"/>
			</fileset>
		</chmod>
		-->
		<antcall target="restartWebServer" /> 
	</target>
	
	<target name="installForE2ETest" depends="packageForE2ETest, cleanInstallForE2eTest">
		<untar src="${build.packageFileForTest}" dest="${build.installForTestPath}" compression="gzip" />
		<!--
		<replace file="${build.installForTestPath}/htdocs/config/mongodb.php">
		    <replacefilter token="scriptureforge" value="scriptureforge_e2etest" />
		</replace>
		<replace file="${build.installForTestPath}/htdocs/config/sf_config.php">
		    <replacefilter token="scriptureforge" value="scriptureforge_e2etest" />
		</replace>
		-->
		<antcall target="restartWebServer" /> 
	</target>
	
	<target name="test-js-e2e" depends="composer,installForE2ETest">
		<exec dir="${build.installForTestPath}/test/app/" executable="php">
			<arg value="setupTestEnvironment.php" />
		</exec>
		<!-- TODO: Consider another design where multiple protractor.conf files can be selected -->
		<!-- TODO: Figure out how to connect to the Windows build agent and start the Selenium server -->
		<exec dir="${build.installForTestPath}/test/app/" executable="node">
			<arg value="node_modules/protractor/bin/protractor" />
			<arg value="protractorConf.js" />
			<arg value="--seleniumAddress" />
			<arg value="http://ba-wxp32a.psonet:4444/wd/hub" />
			<arg value="--baseUrl" />
			<arg value="http://e2etest.languageforge.local/" />
		</exec>
		<exec dir="${build.installForTestPath}/test/app/" executable="php">
			<arg value="teardownTestEnvironment.php" />
		</exec>
	</target>
	
	<target name="run-protractor" depends="unzip-chromedriver">
		<exec dir="test/app/" executable="node">
			<arg value="node_modules/protractor/bin/protractor" />
			<arg value="protractorConf.js" />
			<arg value="--seleniumAddress" />
			<arg value="http://localhost:4444/wd/hub" />
			<arg value="--baseUrl" />
			<arg value="http://languageforge.local" />
			<arg value="--chromeDriver" />
			<arg value="${webdriver.chrome.driver}" />
		</exec>
	</target>
	
	<pathconvert property="selenium.server">
		<!-- Highest version number among selenium-server-standalone-*.jar files -->
		<last>
			<sort>
				<fileset dir="test/app/node_modules/protractor/">
					<include name="selenium/selenium-server-standalone-*.jar" />
				</fileset>
			</sort>
		</last>
	</pathconvert>
	
	<pathconvert property="chromedriver.zip">
		<!-- Highest version number among chromedriver_*.zip files -->
		<last>
			<sort>
				<fileset dir="test/app/node_modules/protractor/">
					<include name="selenium/chromedriver_*.zip" />
				</fileset>
			</sort>
		</last>
	</pathconvert>
	
	<target name="start-selenium">
		<java fork="true" spawn="true" jar="${selenium.server}" />
	</target>
	
	<target name="test-start-selenium">
		<echo message="Selenium server JAR is ${selenium.server}" />
		<echo message="Java home is ${java.home}" />
	</target>
	
	<target name="stop-selenium">
		<get src="http://localhost:4444/selenium-server/driver/?cmd=shutDownSeleniumServer" dest="NUL" />
	</target>
	
	<target name="unzip-chromedriver">
		<unzip src="${chromedriver.zip}" dest="test/app/node_modules/protractor/selenium">
		</unzip>
	</target>
	
	<target name="restartWebServer">
		<exec executable="/etc/init.d/apache2">
			<arg value="restart" />
		</exec>
	</target>
	
	<target name="upload" depends="package,cleanUpload">
		<untar src="${build.packageFile}" dest="${build.uploadPath}" compression="gzip" />
		<chgrp type="both" group="www-data">
			<dirset dir="${build.uploadPath}/htdocs/" />
			<fileset dir="${build.uploadPath}/htdocs/">
			    <include name="**/*"/>
			</fileset>
			<dirset dir="${build.uploadPath}/lib/" />
			<fileset dir="${build.uploadPath}/lib/">
			    <include name="**/*"/>
			</fileset>
		</chgrp>
		<chmod type="both" perm="g+w">
			<dirset dir="${build.uploadPath}/htdocs/cache/" />
			<dirset dir="${build.uploadPath}/htdocs/assets/" />
		</chmod>
		<exec dir="${build.uploadPath}" executable="rsync" failonerror="true">
			<arg value="-vazHAX" />
			<arg value="--delete-during" />
			<arg value='--rsh=ssh -i ${upload.credentials}' />
			<arg value="${build.uploadPath}/" />
			<arg value="${upload.destination}" />
		</exec>
	</target>
	
</project>





:\BuildAgent\jre\bin\java.exe -DJAVA_HOME=C:\BuildAgent\jre "-DMSTest.10.0=C:\Program Files\Microsoft Visual Studio 10.0\Common7\IDE\MSTest.exe" "-DMSTest.9.0=C:\Program Files\Microsoft Visual Studio 9.0\Common7\IDE\MSTest.exe" -Dagent.home.dir=C:\BuildAgent -Dagent.name=ba-wxp32b -Dagent.ownPort=9090 -Dagent.work.dir=C:\BuildAgent\work -Dant.home=C:\BuildAgent\plugins\ant -Dbuild.number=38 -Dbuild.vcs.number=1082573c0d10c2ca4cd18295238ff84a5d9fb268 -Dbuild.vcs.number.1=1082573c0d10c2ca4cd18295238ff84a5d9fb268 -Dbuild.vcs.number.lfsite_master=1082573c0d10c2ca4cd18295238ff84a5d9fb268 -Dfile.encoding=Cp1252 -Djava.io.tmpdir=C:\BuildAgent\temp\buildTmp "-Dos.name=Windows XP" -Dos.version=5.1 -Dpath.separator=; -Dteamcity.agent.cpuBenchmark=332 -Dteamcity.agent.dotnet.agent_url=http://localhost:9090/RPC2 -Dteamcity.agent.dotnet.build_id=39929 -Dteamcity.auth.password=tGtggNYYtoOnIg9DVLFsrhgy4o0GKHVu -Dteamcity.auth.userId=TeamCityBuildId=39929 -Dteamcity.build.changedFiles.file=C:\BuildAgent\temp\buildTmp\changedFiles4471954562356544216.txt -Dteamcity.build.checkoutDir=C:\BuildAgent\work\1fed83628e939d55 -Dteamcity.build.id=39929 -Dteamcity.build.properties.file=C:\BuildAgent\temp\buildTmp\teamcity.build716610294035405285.properties -Dteamcity.build.tempDir=C:\BuildAgent\temp\buildTmp -Dteamcity.build.workingDir=C:\BuildAgent\work\1fed83628e939d55 "-Dteamcity.buildConfName=LF E2E tests" -Dteamcity.buildType.id=bt415 -Dteamcity.configuration.properties.file=C:\BuildAgent\temp\buildTmp\teamcity.config1674322477767976830.properties -Dteamcity.dotnet.nunitaddin=C:\BuildAgent\plugins\dotnetPlugin\bin\JetBrains.TeamCity.NUnitAddin-NUnit -Dteamcity.dotnet.nunitlauncher=C:\BuildAgent\plugins\dotnetPlugin\bin\JetBrains.BuildServer.NUnitLauncher.exe -Dteamcity.dotnet.nunitlauncher.msbuild.task=C:\BuildAgent\plugins\dotnetPlugin\bin\JetBrains.BuildServer.MSBuildLoggers.dll -Dteamcity.dotnet.nunitlauncher1.1=C:\BuildAgent\plugins\dotnetPlugin\bin\JetBrains.BuildServer.NUnitLauncher1.1.exe -Dteamcity.dotnet.nunitlauncher2.0=C:\BuildAgent\plugins\dotnetPlugin\bin\JetBrains.BuildServer.NUnitLauncher2.0.exe -Dteamcity.dotnet.nunitlauncher2.0.vsts=C:\BuildAgent\plugins\dotnetPlugin\bin\JetBrains.BuildServer.NUnitLauncher2.0.VSTS.exe -Dteamcity.dotnet.platform=C:\BuildAgent\plugins\dotnetPlugin\bin\JetBrains.TeamCity.PlatformProcessRunner.1.1.exe -Dteamcity.projectName=LanguageForge -Dteamcity.runner.properties.file=C:\BuildAgent\temp\buildTmp\teamcity.runner1115834263903953300.properties -Dteamcity.runtime.props.file=C:\BuildAgent\temp\agentTmp\ant2195680010703510697runtime -Dteamcity.tests.recentlyFailedTests.file=C:\BuildAgent\temp\buildTmp\testsToRunFirst2232078828175319626.txt "-Dteamcity.version=7.1.5 (build 24400)" -Duser.country=US -Duser.home=C:\ -Duser.language=en -Duser.name=SYSTEM -Duser.timezone=America/New_York -Duser.variant= -Dwebdriver.chrome.driver=C:\BuildAgent\work\1fed83628e939d55\test\app\node_modules\protractor\selenium\chromedriver.exe -classpath C:\BuildAgent\plugins\ant\lib\ant-launcher.jar org.apache.tools.ant.launch.Launcher -lib C:/BuildAgent/plugins/antPlugin/ant-runtime.jar;C:/BuildAgent/lib/runtime-util.jar -listener jetbrains.buildServer.agent.ant.AgentBuildListener -buildfile C:\BuildAgent\work\1fed83628e939d55\build\build-lf.xml run-protractor
